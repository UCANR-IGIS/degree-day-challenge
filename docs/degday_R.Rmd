---
title: "Degree Day Validation Challenge using degday R package"
output: html_notebook
---

# Introduction

This notebook compares the estimated degree day values computed the [`degday`](https://ucanr-igis.github.io/degday/) R package with those from the UC IPM website. This is part of the [Degree Days Validation Challenge](https://ucanr-igis.github.io/degree-day-challenge/).

# Setup 

Load R packages we'll be using below:

```{r results='hide'}
library(dplyr)
library(readr)
library(kableExtra)
```

\

First, install the [`degday`](https://ucanr-igis.github.io/degday/) package if needed.

```{r}
if (!require(degday)) {
  options(repos = c(ajlyons = 'https://ajlyons.r-universe.dev',
                  CRAN = 'https://cloud.r-project.org'))
  install.packages('degday')
  library(degday)
}

packageVersion("degday")
```

\

Load the reference daily min-max temperature data:

```{r}
refdata_tbl <- read_csv("https://raw.githubusercontent.com/UCANR-IGIS/degree-day-challenge/main/data/espartoa-weather-2020.csv")
refdata_tbl %>% slice(1:10)
```

\

Load the official answers:

```{r}
answers_tbl <- read_csv("https://raw.githubusercontent.com/UCANR-IGIS/degree-day-challenge/main/data/ucipm_results/ucipm_low50_high70_all.csv")
answers_tbl %>% slice(1:10)
```

\

# Compute Single-Sine and Single-Triangle Methods

First define upper and lower thresholds:

```{r}
thresh_low <- 50
thresh_up <- 70
```

\

First we compute degree days using the single-sine and single-triangle estimation methods. Here we use the `dd_sng_tri` and `dd_sng_sine` functions from [`degday`](https://ucanr-igis.github.io/degday/).

```{r}
refdata_sng_tbl <- refdata_tbl %>%
  mutate(sng_tri = dd_sng_tri(daily_min = tmin, daily_max = tmax, 
                              thresh_low = thresh_low, thresh_up = thresh_up),
         sng_sine = dd_sng_sine(daily_min = tmin, daily_max = tmax, 
                                thresh_low = thresh_low, thresh_up = thresh_up))

refdata_sng_tbl %>% slice(1:10)
```

### Compare Results

Here we compare the values generated by [`degday`](https://ucanr-igis.github.io/degday/) to the official answers.

Start by comparing we have the same number of rows:

```{r}
nrow(refdata_sng_tbl) == nrow(answers_tbl)
```

\

Next we can display them side-by-side:

```{r}
ddvals_answers_sng_tbl <- refdata_sng_tbl %>% 
  bind_cols(answers_tbl %>% select(sngsine_horiz, sngtri_horiz)) %>% 
  select(date, sng_tri, sngtri_horiz, sng_sine, sngsine_horiz)

ddvals_answers_sng_tbl %>% slice(1:20)
```

\

Inspect in a View window (uncomment and run in RStudio):

```{r}
# ddvals_answers_sng_tbl %>% View()
```

\

Compute the difference between the values computed by [`degday`](https://ucanr-igis.github.io/degday/) and the official answers from UC IPM:

```{r}
ddvals_answers_sng_tbl %>% 
  mutate(sngtri_diff = sng_tri - sngtri_horiz,
         sngsine_diff = sng_sine - sngsine_horiz) %>% 
  select(date, sng_tri, sngtri_horiz, sngtri_diff, sng_sine, sngsine_horiz, sngsine_diff) %>% 
  mutate(sngtri_diff = cell_spec(sngtri_diff,
                                 bold = sngtri_diff != 0,
                                 color = ifelse(sngtri_diff == 0, "black", "red")),
         sngsine_diff = cell_spec(sngsine_diff,
                                 bold = sngsine_diff != 0,
                                 color = ifelse(sngsine_diff == 0, "black", "red"))) %>% 
  kable(escape = FALSE) %>% 
  kable_styling()
```

\

**CONCLUSION: It looks like the answers align to within 2 decimal places.**

\

# Compute Double-Triangle and Double-Sine Values

Next we estimate degree days using the double-triangle and double-sine methods. As illustrated on the `degday` [Getting Started](https://ucanr-igis.github.io/degday/index.html) page, this requires that we add the next-day temperature to the table.

```{r}
refdata_wthnxtday_tbl <- refdata_tbl %>%
  mutate(tmin_next = lead(tmin, n = 1)) 

refdata_wthnxtday_tbl %>% head()
```


\

Now compute estimated degree days using `dd_dbl_tri` and `dd_dbl_sine` functions from [`degday`](https://ucanr-igis.github.io/degday/).

```{r}
refdata_dbl_tbl <- refdata_wthnxtday_tbl %>%
  mutate(dbl_tri = dd_dbl_tri(daily_min = tmin, daily_max = tmax, nextday_min = tmin_next,
                              thresh_low = thresh_low, thresh_up = thresh_up),
         dbl_sine = dd_dbl_sine(daily_min = tmin, daily_max = tmax, nextday_min = tmin_next,
                                thresh_low = thresh_low, thresh_up = thresh_up))  

refdata_dbl_tbl %>% slice(1:10)
```

### Compare Results

Here we compare the values generated by [`degday`](https://ucanr-igis.github.io/degday/) to the official answers.

Start by comparing we have the same number of rows:

```{r}
nrow(refdata_dbl_tbl) == nrow(answers_tbl)
```

\ 

Next we can display them side-by-side:

```{r}
ddvals_answers_dbl_tbl <- refdata_dbl_tbl %>% 
  bind_cols(answers_tbl %>% select(dblsine_horiz, dbltri_horiz)) %>% 
  select(date, dbl_tri, dbltri_horiz, dbl_sine, dblsine_horiz)

ddvals_answers_dbl_tbl %>% slice(1:20)
```

\

Compute the difference between the values computed by [`degday`](https://ucanr-igis.github.io/degday/) and the official answers from UC IPM:

```{r}
ddvals_answers_dbl_tbl %>% 
  mutate(dbltri_diff = dbl_tri - dbltri_horiz,
         dblsine_diff = dbl_sine - dblsine_horiz) %>% 
  select(date, dbl_tri, dbltri_horiz, dbltri_diff, dbl_sine, dblsine_horiz, dblsine_diff) %>% 
  mutate(dbltri_diff = cell_spec(dbltri_diff,
                                 bold = dbltri_diff != 0,
                                 color = ifelse(dbltri_diff == 0, "black", "red")),
         dblsine_diff = cell_spec(dblsine_diff,
                                 bold = dblsine_diff != 0,
                                 color = ifelse(dblsine_diff == 0, "black", "red"))) %>% 
  kable(escape = FALSE) %>% 
  kable_styling()
```

# Conclusion

The estimated degree day values computed by [`degday`](https://ucanr-igis.github.io/degday/) match the values from the UC IPM website.



